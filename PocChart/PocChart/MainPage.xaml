<?xml version="1.0" encoding="utf-8" ?>
<!-- MainPage.xaml -->

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:PocChart.ViewModels"
             xmlns:models="clr-namespace:PocChart.Models"
             xmlns:local="clr-namespace:PocChart"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:converters="clr-namespace:PocChart.Converters" 
             x:DataType="local:ViewModels.AccountsViewModel"
             x:Class="PocChart.MainPage"
             Title="Mes Comptes">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:CountToBoolConverter x:Key="CountToBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior
            EventName="Appearing"
            Command="{Binding InitializeCommand}" />
    </ContentPage.Behaviors>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="15">

            <!-- Section 1: Ajouter un nouveau compte -->
            <Border Padding="15">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Ajouter un compte" FontSize="Medium" FontAttributes="Bold"/>
                    <Entry Placeholder="Nom du compte (ex: Livret A)" Text="{Binding NewAccountName}"/>
                    <Button Text="Ajouter le Compte" Command="{Binding AddAccountCommand}"/>
                </VerticalStackLayout>
            </Border>

            <!-- Section 2: Ajouter une entrée de solde -->
            <Border Padding="15">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Ajouter un solde" FontSize="Medium" FontAttributes="Bold"/>

                    <Picker Title="Sélectionner un compte"
                            ItemsSource="{Binding Accounts}"
                            ItemDisplayBinding="{Binding Name}"
                            SelectedItem="{Binding SelectedAccount}"/>

                    <Entry Placeholder="Nouveau solde" Keyboard="Numeric" Text="{Binding NewBalanceValue}"/>
                    <DatePicker Date="{Binding NewBalanceDate}"/>

                    <Button Text="Enregistrer le Solde" Command="{Binding AddBalanceEntryCommand}"/>
                </VerticalStackLayout>
            </Border>

            <!-- Section 3: Affichage du graphique -->
            <Border Stroke="LightGray" StrokeThickness="1" Padding="15">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10"/>
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="10">
                    <Label Text="Analyse de l'évolution mensuelle" FontSize="Medium" FontAttributes="Bold"/>

                    <!-- Boutons pour choisir la période -->
                    <HorizontalStackLayout Spacing="10" HorizontalOptions="Center">
                        <Button Text="Sur 3 mois" 
                    Command="{Binding CalculerEvolutionCommand}"
                    CommandParameter="3" />
                        <Button Text="Sur 12 mois"
                    Command="{Binding CalculerEvolutionCommand}"
                    CommandParameter="12" />
                    </HorizontalStackLayout>

                    <!-- NOUVELLE ZONE D'AFFICHAGE AVEC DES COLONNES -->
                    <!-- Le CollectionView est invisible s'il est vide -->
                    <CollectionView ItemsSource="{Binding EvolutionMensuelle}" IsVisible="{Binding EvolutionMensuelle.Count, Converter={StaticResource CountToBoolConverter}}">
                        <CollectionView.ItemsLayout>
                            <!-- Grille qui s'adapte au contenu -->
                            <GridItemsLayout Orientation="Horizontal" HorizontalItemSpacing="5" />
                        </CollectionView.ItemsLayout>

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:MonthlyEvolution">
                                <Border Stroke="Gainsboro" StrokeThickness="1" Padding="10" Margin="0,5,0,5" WidthRequest="160">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="5"/>
                                    </Border.StrokeShape>

                                    <VerticalStackLayout Spacing="5" HorizontalOptions="Center" VerticalOptions="Center">
                                        <Label Text="{Binding MonthName}" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                                        <BoxView HeightRequest="1" Color="Gainsboro"/>
                                        <Label Text="{Binding EvolutionValue}" TextColor="{Binding TextColor}" FontSize="18" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                                        <Label Text="{Binding EvolutionPercentage}" TextColor="{Binding TextColor}" FontSize="14" HorizontalTextAlignment="Center"/>
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
